import json
from datetime import datetime
import stat

from django.conf import settings
from django.contrib.gis.geos import GEOSGeometry
from contextlib import ContextDecorator
from django.db import connection
from requests import Response
from batid.models import City, Building, AsyncSignal, ADS
from batid.services.signal import AsyncSignalDispatcher
import os


def dispatch_signals():
    signals = AsyncSignal.objects.filter(handled_at__isnull=True).order_by("created_at")

    dispatcher = AsyncSignalDispatcher()
    for s in signals:
        dispatcher.dispatch(s)


def create_paris():
    geometry = {
        "type": "MultiPolygon",
        "coordinates": [
            [
                [
                    [2.364204, 48.816398],
                    [2.363329, 48.816148],
                    [2.360158, 48.816057],
                    [2.356895, 48.815972],
                    [2.356232, 48.815943],
                    [2.355852, 48.815923],
                    [2.354735, 48.816813],
                    [2.353049, 48.818034],
                    [2.352392, 48.818551],
                    [2.351254, 48.817962],
                    [2.350489, 48.817614],
                    [2.34903, 48.816964],
                    [2.348763, 48.816855],
                    [2.347178, 48.816102],
                    [2.34692, 48.816018],
                    [2.346633, 48.815986],
                    [2.346371, 48.815994],
                    [2.345544, 48.816078],
                    [2.345191, 48.816092],
                    [2.344755, 48.816073],
                    [2.344356, 48.816016],
                    [2.344464, 48.815611],
                    [2.344448, 48.815562],
                    [2.343903, 48.815767],
                    [2.343157, 48.816045],
                    [2.342877, 48.816116],
                    [2.342186, 48.81625],
                    [2.341684, 48.81633],
                    [2.340512, 48.816372],
                    [2.339543, 48.816436],
                    [2.338007, 48.816515],
                    [2.335581, 48.816655],
                    [2.333711, 48.816771],
                    [2.331898, 48.817011],
                    [2.332461, 48.818247],
                    [2.330414, 48.818704],
                    [2.325562, 48.819774],
                    [2.321661, 48.820629],
                    [2.320597, 48.820867],
                    [2.314146, 48.822291],
                    [2.306959, 48.823868],
                    [2.303185, 48.824727],
                    [2.301866, 48.825002],
                    [2.301315, 48.825126],
                    [2.300177, 48.825375],
                    [2.292192, 48.827142],
                    [2.290235, 48.827989],
                    [2.289408, 48.828334],
                    [2.286694, 48.829452],
                    [2.284719, 48.830291],
                    [2.283586, 48.830796],
                    [2.282671, 48.831153],
                    [2.279945, 48.832141],
                    [2.279052, 48.83249],
                    [2.278827, 48.832293],
                    [2.276297, 48.830232],
                    [2.275304, 48.829435],
                    [2.275276, 48.829446],
                    [2.272928, 48.828039],
                    [2.272793, 48.82792],
                    [2.267826, 48.827836],
                    [2.267626, 48.827969],
                    [2.267339, 48.831532],
                    [2.269645, 48.832857],
                    [2.269931, 48.833011],
                    [2.268102, 48.834428],
                    [2.267789, 48.834585],
                    [2.267475, 48.834593],
                    [2.262792, 48.833923],
                    [2.261492, 48.83407],
                    [2.258503, 48.834419],
                    [2.256995, 48.834601],
                    [2.256538, 48.834643],
                    [2.255144, 48.83481],
                    [2.254831, 48.835184],
                    [2.253547, 48.836676],
                    [2.25239, 48.838036],
                    [2.252011, 48.838493],
                    [2.251915, 48.838641],
                    [2.251709, 48.838822],
                    [2.251309, 48.84206],
                    [2.251216, 48.84289],
                    [2.251735, 48.843974],
                    [2.251909, 48.844291],
                    [2.252347, 48.845191],
                    [2.252478, 48.845486],
                    [2.250767, 48.845531],
                    [2.250516, 48.845555],
                    [2.249867, 48.84573],
                    [2.245935, 48.846745],
                    [2.245515, 48.846856],
                    [2.243235, 48.847431],
                    [2.242362, 48.847658],
                    [2.241761, 48.848135],
                    [2.241516, 48.848408],
                    [2.2405, 48.849316],
                    [2.240184, 48.849571],
                    [2.23977, 48.849832],
                    [2.23918, 48.850042],
                    [2.238966, 48.850094],
                    [2.237379, 48.850435],
                    [2.235663, 48.850818],
                    [2.233576, 48.851304],
                    [2.233194, 48.85138],
                    [2.232297, 48.851587],
                    [2.231537, 48.85174],
                    [2.230011, 48.852065],
                    [2.229228, 48.852224],
                    [2.226594, 48.852812],
                    [2.226233, 48.852962],
                    [2.225912, 48.853035],
                    [2.224219, 48.853517],
                    [2.224269, 48.855088],
                    [2.224315, 48.855696],
                    [2.224407, 48.856154],
                    [2.224518, 48.856538],
                    [2.22532, 48.858516],
                    [2.22567, 48.859405],
                    [2.225968, 48.860015],
                    [2.226992, 48.862],
                    [2.227181, 48.862385],
                    [2.227361, 48.862829],
                    [2.227749, 48.863844],
                    [2.228139, 48.864922],
                    [2.228377, 48.86538],
                    [2.229797, 48.867072],
                    [2.230181, 48.867504],
                    [2.230659, 48.86808],
                    [2.231376, 48.868728],
                    [2.231736, 48.869069],
                    [2.232175, 48.869285],
                    [2.232868, 48.869585],
                    [2.233702, 48.869898],
                    [2.235576, 48.870523],
                    [2.236657, 48.870821],
                    [2.237436, 48.871022],
                    [2.238434, 48.871311],
                    [2.239593, 48.871705],
                    [2.24035, 48.872033],
                    [2.240945, 48.872342],
                    [2.241237, 48.87251],
                    [2.241856, 48.872901],
                    [2.242723, 48.873543],
                    [2.243269, 48.874017],
                    [2.243948, 48.874712],
                    [2.245157, 48.875904],
                    [2.245704, 48.876459],
                    [2.24625, 48.876228],
                    [2.246533, 48.876142],
                    [2.254817, 48.874081],
                    [2.25541, 48.874264],
                    [2.258467, 48.880387],
                    [2.258861, 48.880333],
                    [2.264611, 48.879622],
                    [2.277487, 48.877968],
                    [2.27947, 48.878532],
                    [2.279949, 48.878573],
                    [2.280536, 48.881107],
                    [2.280632, 48.8816],
                    [2.280897, 48.882792],
                    [2.281014, 48.882971],
                    [2.284538, 48.885574],
                    [2.28446, 48.885639],
                    [2.285642, 48.886555],
                    [2.290529, 48.888956],
                    [2.291148, 48.889302],
                    [2.291634, 48.889456],
                    [2.292941, 48.889619],
                    [2.294041, 48.889744],
                    [2.295013, 48.889875],
                    [2.295475, 48.890096],
                    [2.297327, 48.891054],
                    [2.29811, 48.891444],
                    [2.298628, 48.891717],
                    [2.300588, 48.892629],
                    [2.301836, 48.89324],
                    [2.303319, 48.893934],
                    [2.303774, 48.894154],
                    [2.305715, 48.89509],
                    [2.307687, 48.89601],
                    [2.310673, 48.897131],
                    [2.312319, 48.897725],
                    [2.312451, 48.897782],
                    [2.31852, 48.899638],
                    [2.319887, 48.90046],
                    [2.320434, 48.900776],
                    [2.322073, 48.900828],
                    [2.322174, 48.900794],
                    [2.32327, 48.900813],
                    [2.325836, 48.900954],
                    [2.326534, 48.900977],
                    [2.330147, 48.901044],
                    [2.331996, 48.901078],
                    [2.337938, 48.901208],
                    [2.339771, 48.901245],
                    [2.344985, 48.901345],
                    [2.351984, 48.901485],
                    [2.355239, 48.901548],
                    [2.36562, 48.901758],
                    [2.367964, 48.90181],
                    [2.369103, 48.901823],
                    [2.370302, 48.901848],
                    [2.372017, 48.901885],
                    [2.383566, 48.902126],
                    [2.38453, 48.902148],
                    [2.385582, 48.901931],
                    [2.388185, 48.901382],
                    [2.389332, 48.901161],
                    [2.390649, 48.900927],
                    [2.390837, 48.900907],
                    [2.391772, 48.900383],
                    [2.392379, 48.900033],
                    [2.39279, 48.899812],
                    [2.393434, 48.899438],
                    [2.395518, 48.898265],
                    [2.395613, 48.898166],
                    [2.396919, 48.895861],
                    [2.397609, 48.894722],
                    [2.397668, 48.894606],
                    [2.397882, 48.893873],
                    [2.397999, 48.893529],
                    [2.398236, 48.89264],
                    [2.398903, 48.889681],
                    [2.398942, 48.889532],
                    [2.399136, 48.888532],
                    [2.399252, 48.885362],
                    [2.400107, 48.883821],
                    [2.400582, 48.883411],
                    [2.401507, 48.882631],
                    [2.404576, 48.881269],
                    [2.405612, 48.881007],
                    [2.408068, 48.88051],
                    [2.40936, 48.880256],
                    [2.410682, 48.878593],
                    [2.41082, 48.878436],
                    [2.412453, 48.876443],
                    [2.413431, 48.87314],
                    [2.413646, 48.872438],
                    [2.41372, 48.871558],
                    [2.413812, 48.870744],
                    [2.413956, 48.869216],
                    [2.413961, 48.867513],
                    [2.414012, 48.866486],
                    [2.413979, 48.865384],
                    [2.413976, 48.864978],
                    [2.413951, 48.864712],
                    [2.414137, 48.863373],
                    [2.414266, 48.862099],
                    [2.41437, 48.860649],
                    [2.41442, 48.860242],
                    [2.414702, 48.858704],
                    [2.414947, 48.857272],
                    [2.415121, 48.856157],
                    [2.415286, 48.855178],
                    [2.415476, 48.854165],
                    [2.415986, 48.85136],
                    [2.416326, 48.849371],
                    [2.416341, 48.849234],
                    [2.41635, 48.8487],
                    [2.416083, 48.847258],
                    [2.415971, 48.846623],
                    [2.415768, 48.845445],
                    [2.415664, 48.844996],
                    [2.415299, 48.84385],
                    [2.41485, 48.842379],
                    [2.414248, 48.840488],
                    [2.414047, 48.83976],
                    [2.413577, 48.838278],
                    [2.412852, 48.836217],
                    [2.412246, 48.834539],
                    [2.411472, 48.833929],
                    [2.412587, 48.833779],
                    [2.413505, 48.833723],
                    [2.413921, 48.833712],
                    [2.414633, 48.833728],
                    [2.41547, 48.833794],
                    [2.415968, 48.833864],
                    [2.416608, 48.833997],
                    [2.417338, 48.834189],
                    [2.41935, 48.834832],
                    [2.421016, 48.835398],
                    [2.422139, 48.835798],
                    [2.421801, 48.836348],
                    [2.421586, 48.836756],
                    [2.421447, 48.837219],
                    [2.421254, 48.838161],
                    [2.421062, 48.838891],
                    [2.42093, 48.839329],
                    [2.420719, 48.839806],
                    [2.420475, 48.840314],
                    [2.420304, 48.840564],
                    [2.420133, 48.840753],
                    [2.419776, 48.841082],
                    [2.419539, 48.841449],
                    [2.419394, 48.841997],
                    [2.419357, 48.842498],
                    [2.419469, 48.842692],
                    [2.419735, 48.84294],
                    [2.419849, 48.843102],
                    [2.41986, 48.843456],
                    [2.420115, 48.843601],
                    [2.421848, 48.844437],
                    [2.422225, 48.84423],
                    [2.422435, 48.844058],
                    [2.422653, 48.843837],
                    [2.422966, 48.843417],
                    [2.423283, 48.842912],
                    [2.423492, 48.842656],
                    [2.423948, 48.842196],
                    [2.424347, 48.84195],
                    [2.424535, 48.841886],
                    [2.42492, 48.841808],
                    [2.425819, 48.841715],
                    [2.427575, 48.841571],
                    [2.42813, 48.841528],
                    [2.43064, 48.841299],
                    [2.431533, 48.841228],
                    [2.432249, 48.841161],
                    [2.432916, 48.841114],
                    [2.433545, 48.841046],
                    [2.43367, 48.841198],
                    [2.435777, 48.84102],
                    [2.437184, 48.840893],
                    [2.437282, 48.841326],
                    [2.437958, 48.844664],
                    [2.439489, 48.844521],
                    [2.44052, 48.84444],
                    [2.440616, 48.844892],
                    [2.440801, 48.844879],
                    [2.440864, 48.845252],
                    [2.440681, 48.845247],
                    [2.440758, 48.845964],
                    [2.441832, 48.845916],
                    [2.444136, 48.845878],
                    [2.444921, 48.845869],
                    [2.446646, 48.845802],
                    [2.446497, 48.844968],
                    [2.446969, 48.84494],
                    [2.447853, 48.844863],
                    [2.448654, 48.844781],
                    [2.449527, 48.844677],
                    [2.450814, 48.844502],
                    [2.451866, 48.844329],
                    [2.452621, 48.844217],
                    [2.453503, 48.844101],
                    [2.455169, 48.843919],
                    [2.456779, 48.843708],
                    [2.458615, 48.843428],
                    [2.459873, 48.843181],
                    [2.461008, 48.842938],
                    [2.461794, 48.842731],
                    [2.462446, 48.842532],
                    [2.462848, 48.84239],
                    [2.463741, 48.842023],
                    [2.464181, 48.841809],
                    [2.464903, 48.841406],
                    [2.465411, 48.841066],
                    [2.465699, 48.840836],
                    [2.466164, 48.840423],
                    [2.466639, 48.839925],
                    [2.466929, 48.839596],
                    [2.467319, 48.839099],
                    [2.467787, 48.838577],
                    [2.468076, 48.838303],
                    [2.468547, 48.837902],
                    [2.469236, 48.837289],
                    [2.469473, 48.837048],
                    [2.469662, 48.836788],
                    [2.469803, 48.836547],
                    [2.469851, 48.836399],
                    [2.469834, 48.835798],
                    [2.469724, 48.835195],
                    [2.469483, 48.834547],
                    [2.469197, 48.83412],
                    [2.468891, 48.833797],
                    [2.468485, 48.833507],
                    [2.467882, 48.833204],
                    [2.467329, 48.832952],
                    [2.466939, 48.832749],
                    [2.466569, 48.832521],
                    [2.466273, 48.832296],
                    [2.465823, 48.83187],
                    [2.465575, 48.831555],
                    [2.465584, 48.831471],
                    [2.465426, 48.83132],
                    [2.465273, 48.831018],
                    [2.465077, 48.830568],
                    [2.464806, 48.829684],
                    [2.464702, 48.829277],
                    [2.46465, 48.828956],
                    [2.464608, 48.828535],
                    [2.464662, 48.827623],
                    [2.465095, 48.827541],
                    [2.465232, 48.827667],
                    [2.465434, 48.827567],
                    [2.466178, 48.827328],
                    [2.465731, 48.826226],
                    [2.465503, 48.825586],
                    [2.46532, 48.824979],
                    [2.465189, 48.824957],
                    [2.465299, 48.824705],
                    [2.465044, 48.824084],
                    [2.464026, 48.822303],
                    [2.463725, 48.821678],
                    [2.463403, 48.821149],
                    [2.462867, 48.820178],
                    [2.462697, 48.819369],
                    [2.462529, 48.819246],
                    [2.462696, 48.81906],
                    [2.461205, 48.818355],
                    [2.46053, 48.818027],
                    [2.459541, 48.817571],
                    [2.459115, 48.817365],
                    [2.459414, 48.816848],
                    [2.459119, 48.816997],
                    [2.458717, 48.817034],
                    [2.458054, 48.81702],
                    [2.455919, 48.817082],
                    [2.455102, 48.817076],
                    [2.453452, 48.817149],
                    [2.452526, 48.817317],
                    [2.451315, 48.817619],
                    [2.450558, 48.817773],
                    [2.449671, 48.817893],
                    [2.448935, 48.81793],
                    [2.447786, 48.817966],
                    [2.446618, 48.81793],
                    [2.445958, 48.817928],
                    [2.444713, 48.817897],
                    [2.444181, 48.817875],
                    [2.443731, 48.817892],
                    [2.442326, 48.817904],
                    [2.441855, 48.817944],
                    [2.441012, 48.818093],
                    [2.440137, 48.818259],
                    [2.439854, 48.818291],
                    [2.4394, 48.81828],
                    [2.437329, 48.818177],
                    [2.437442, 48.819111],
                    [2.437345, 48.819187],
                    [2.436925, 48.819365],
                    [2.436332, 48.819543],
                    [2.436028, 48.819593],
                    [2.434902, 48.819669],
                    [2.434655, 48.819557],
                    [2.434144, 48.819216],
                    [2.434262, 48.819911],
                    [2.434288, 48.820158],
                    [2.434108, 48.820297],
                    [2.433094, 48.820991],
                    [2.43248, 48.821426],
                    [2.43289, 48.821693],
                    [2.432634, 48.821901],
                    [2.432195, 48.82162],
                    [2.430371, 48.822877],
                    [2.430628, 48.823157],
                    [2.429861, 48.823432],
                    [2.429227, 48.823622],
                    [2.428768, 48.823733],
                    [2.427958, 48.8239],
                    [2.427421, 48.823987],
                    [2.426575, 48.824097],
                    [2.425481, 48.824176],
                    [2.424654, 48.824191],
                    [2.42345, 48.824158],
                    [2.422878, 48.82413],
                    [2.421826, 48.824059],
                    [2.420678, 48.824048],
                    [2.419963, 48.82408],
                    [2.419387, 48.824156],
                    [2.418603, 48.824312],
                    [2.417763, 48.824531],
                    [2.417131, 48.824649],
                    [2.416513, 48.824736],
                    [2.415976, 48.824777],
                    [2.415083, 48.824782],
                    [2.413785, 48.824723],
                    [2.413111, 48.824718],
                    [2.412623, 48.824737],
                    [2.411757, 48.824803],
                    [2.410907, 48.82494],
                    [2.41027, 48.825087],
                    [2.409955, 48.825183],
                    [2.409175, 48.825502],
                    [2.408675, 48.825767],
                    [2.408085, 48.826112],
                    [2.407589, 48.82643],
                    [2.40655, 48.827191],
                    [2.405816, 48.827797],
                    [2.405376, 48.828134],
                    [2.404994, 48.828403],
                    [2.403814, 48.82906],
                    [2.403551, 48.829175],
                    [2.402871, 48.829415],
                    [2.402237, 48.82959],
                    [2.400679, 48.829095],
                    [2.399775, 48.828791],
                    [2.399205, 48.828626],
                    [2.397894, 48.828329],
                    [2.396843, 48.828054],
                    [2.395707, 48.827727],
                    [2.395179, 48.827645],
                    [2.39434, 48.827539],
                    [2.393993, 48.827401],
                    [2.392762, 48.826855],
                    [2.391022, 48.826117],
                    [2.390072, 48.825692],
                    [2.389445, 48.825345],
                    [2.3888, 48.825106],
                    [2.387894, 48.824805],
                    [2.386941, 48.824463],
                    [2.385226, 48.823729],
                    [2.383142, 48.82299],
                    [2.381524, 48.822411],
                    [2.380767, 48.821701],
                    [2.379478, 48.821273],
                    [2.379083, 48.821158],
                    [2.377884, 48.82078],
                    [2.376526, 48.820319],
                    [2.376077, 48.820156],
                    [2.375597, 48.82001],
                    [2.374589, 48.819681],
                    [2.373978, 48.819506],
                    [2.373705, 48.819413],
                    [2.372608, 48.819074],
                    [2.371497, 48.818702],
                    [2.370643, 48.818433],
                    [2.369484, 48.81808],
                    [2.367102, 48.817301],
                    [2.365641, 48.816849],
                    [2.365029, 48.816671],
                    [2.364204, 48.816398],
                ]
            ]
        ],
    }
    geom = GEOSGeometry(json.dumps(geometry), srid=4326)
    return City.objects.create(name="Paris", shape=geom, code_insee="75056")


def create_cenac():
    geometry = {
        "type": "MultiPolygon",
        "coordinates": [
            [
                [
                    [-0.434557, 44.771869],
                    [-0.435364, 44.770572],
                    [-0.435929, 44.770513],
                    [-0.43676, 44.770717],
                    [-0.437215, 44.770975],
                    [-0.437534, 44.771012],
                    [-0.437594, 44.770966],
                    [-0.438134, 44.770142],
                    [-0.438182, 44.769826],
                    [-0.438771, 44.769741],
                    [-0.439223, 44.7697],
                    [-0.440315, 44.769579],
                    [-0.441081, 44.769472],
                    [-0.442654, 44.769266],
                    [-0.443044, 44.769261],
                    [-0.444472, 44.769277],
                    [-0.446272, 44.76933],
                    [-0.44812, 44.769342],
                    [-0.449071, 44.769366],
                    [-0.449987, 44.769378],
                    [-0.450806, 44.769431],
                    [-0.45301, 44.769669],
                    [-0.453384, 44.769686],
                    [-0.453686, 44.76967],
                    [-0.455007, 44.769496],
                    [-0.456191, 44.769302],
                    [-0.456489, 44.769237],
                    [-0.457271, 44.769036],
                    [-0.457417, 44.769038],
                    [-0.458462, 44.768823],
                    [-0.458891, 44.768707],
                    [-0.460057, 44.769175],
                    [-0.463445, 44.770142],
                    [-0.462699, 44.770396],
                    [-0.46234, 44.770529],
                    [-0.461755, 44.770825],
                    [-0.462191, 44.771191],
                    [-0.464478, 44.772708],
                    [-0.465201, 44.773274],
                    [-0.465796, 44.773828],
                    [-0.465795, 44.773979],
                    [-0.466166, 44.774659],
                    [-0.466354, 44.774838],
                    [-0.467666, 44.775039],
                    [-0.468099, 44.775126],
                    [-0.469262, 44.775133],
                    [-0.469161, 44.775388],
                    [-0.471704, 44.775683],
                    [-0.471761, 44.775592],
                    [-0.471951, 44.775587],
                    [-0.47356, 44.776175],
                    [-0.47471, 44.776425],
                    [-0.475533, 44.776449],
                    [-0.47578, 44.776353],
                    [-0.477014, 44.776236],
                    [-0.477188, 44.776592],
                    [-0.477567, 44.777187],
                    [-0.477755, 44.777446],
                    [-0.478203, 44.77793],
                    [-0.478311, 44.778138],
                    [-0.478516, 44.77884],
                    [-0.47854, 44.779243],
                    [-0.477469, 44.779626],
                    [-0.477171, 44.779741],
                    [-0.477252, 44.781986],
                    [-0.477758, 44.782765],
                    [-0.477904, 44.783156],
                    [-0.478482, 44.784339],
                    [-0.479024, 44.784981],
                    [-0.479946, 44.785814],
                    [-0.479494, 44.785862],
                    [-0.479077, 44.785881],
                    [-0.478555, 44.785832],
                    [-0.477219, 44.785874],
                    [-0.477116, 44.785735],
                    [-0.476347, 44.785314],
                    [-0.475871, 44.785105],
                    [-0.475234, 44.785147],
                    [-0.474844, 44.785235],
                    [-0.474038, 44.78555],
                    [-0.473402, 44.785828],
                    [-0.4722, 44.786734],
                    [-0.471826, 44.786947],
                    [-0.471206, 44.787197],
                    [-0.470521, 44.787395],
                    [-0.470234, 44.787708],
                    [-0.46933, 44.788568],
                    [-0.468857, 44.788967],
                    [-0.468758, 44.789276],
                    [-0.469017, 44.789908],
                    [-0.469305, 44.790342],
                    [-0.469892, 44.790975],
                    [-0.46994, 44.791154],
                    [-0.46992, 44.791505],
                    [-0.469699, 44.791767],
                    [-0.469392, 44.791929],
                    [-0.469013, 44.792276],
                    [-0.468696, 44.793057],
                    [-0.468674, 44.793413],
                    [-0.46837, 44.793758],
                    [-0.468022, 44.793949],
                    [-0.467836, 44.79427],
                    [-0.467915, 44.794886],
                    [-0.467835, 44.795125],
                    [-0.467401, 44.795226],
                    [-0.467279, 44.795368],
                    [-0.467088, 44.795487],
                    [-0.46686, 44.795508],
                    [-0.466671, 44.795472],
                    [-0.466537, 44.795686],
                    [-0.466301, 44.795606],
                    [-0.465789, 44.796107],
                    [-0.465374, 44.796578],
                    [-0.465063, 44.796794],
                    [-0.465718, 44.797005],
                    [-0.465406, 44.797151],
                    [-0.465278, 44.79738],
                    [-0.46511, 44.797566],
                    [-0.464843, 44.797756],
                    [-0.464667, 44.797788],
                    [-0.464269, 44.797729],
                    [-0.464094, 44.797775],
                    [-0.463783, 44.798303],
                    [-0.463154, 44.798563],
                    [-0.463171, 44.798789],
                    [-0.46307, 44.798909],
                    [-0.462804, 44.799016],
                    [-0.462702, 44.799209],
                    [-0.462212, 44.799449],
                    [-0.461913, 44.799469],
                    [-0.461718, 44.799566],
                    [-0.461634, 44.799802],
                    [-0.461499, 44.799845],
                    [-0.461365, 44.799766],
                    [-0.461198, 44.799778],
                    [-0.461145, 44.799881],
                    [-0.461181, 44.800051],
                    [-0.461316, 44.800212],
                    [-0.461236, 44.800263],
                    [-0.460873, 44.800245],
                    [-0.460769, 44.800315],
                    [-0.460333, 44.800218],
                    [-0.460083, 44.800101],
                    [-0.459902, 44.800118],
                    [-0.459646, 44.800209],
                    [-0.459305, 44.800111],
                    [-0.458971, 44.800142],
                    [-0.458823, 44.800098],
                    [-0.4586, 44.799973],
                    [-0.458404, 44.800055],
                    [-0.457726, 44.8],
                    [-0.457463, 44.799938],
                    [-0.457123, 44.800168],
                    [-0.456864, 44.800288],
                    [-0.456616, 44.800367],
                    [-0.456144, 44.800475],
                    [-0.45542, 44.800551],
                    [-0.45523, 44.799611],
                    [-0.455163, 44.799628],
                    [-0.454163, 44.800038],
                    [-0.453609, 44.800294],
                    [-0.45212, 44.801102],
                    [-0.451766, 44.800807],
                    [-0.451143, 44.800496],
                    [-0.450613, 44.800014],
                    [-0.450332, 44.799436],
                    [-0.450279, 44.798357],
                    [-0.449895, 44.798268],
                    [-0.450166, 44.797361],
                    [-0.450123, 44.796507],
                    [-0.448698, 44.795822],
                    [-0.448868, 44.795413],
                    [-0.447909, 44.794943],
                    [-0.4479, 44.794763],
                    [-0.447958, 44.794671],
                    [-0.447889, 44.794538],
                    [-0.446534, 44.793987],
                    [-0.446273, 44.793814],
                    [-0.446377, 44.793362],
                    [-0.444639, 44.792731],
                    [-0.445049, 44.79209],
                    [-0.445997, 44.790806],
                    [-0.446477, 44.790299],
                    [-0.446646, 44.78989],
                    [-0.446567, 44.789577],
                    [-0.446313, 44.789538],
                    [-0.444604, 44.789482],
                    [-0.443456, 44.789286],
                    [-0.442681, 44.788946],
                    [-0.443067, 44.787818],
                    [-0.441785, 44.787325],
                    [-0.440793, 44.786898],
                    [-0.440405, 44.786622],
                    [-0.441465, 44.785826],
                    [-0.441774, 44.785683],
                    [-0.441697, 44.785415],
                    [-0.441228, 44.784887],
                    [-0.440553, 44.784004],
                    [-0.441171, 44.780919],
                    [-0.441227, 44.780783],
                    [-0.441543, 44.780775],
                    [-0.441835, 44.780319],
                    [-0.442136, 44.780005],
                    [-0.441875, 44.779686],
                    [-0.442067, 44.779384],
                    [-0.442176, 44.778771],
                    [-0.442338, 44.778493],
                    [-0.442315, 44.778382],
                    [-0.441695, 44.778289],
                    [-0.441252, 44.778104],
                    [-0.440928, 44.777942],
                    [-0.440236, 44.777918],
                    [-0.439819, 44.777872],
                    [-0.43954, 44.777822],
                    [-0.439228, 44.777536],
                    [-0.439013, 44.777161],
                    [-0.438971, 44.776698],
                    [-0.438696, 44.775946],
                    [-0.438384, 44.774886],
                    [-0.437959, 44.77425],
                    [-0.437355, 44.773632],
                    [-0.43668, 44.773157],
                    [-0.435856, 44.77246],
                    [-0.435432, 44.772246],
                    [-0.434557, 44.771869],
                ]
            ]
        ],
    }

    geom = GEOSGeometry(json.dumps(geometry), srid=4326)
    return City.objects.create(name="Cénac", shape=geom, code_insee="33118")


def create_grenoble():
    geometry = {
        "type": "MultiPolygon",
        "coordinates": [
            [
                [
                    [5.678683, 45.213686],
                    [5.679474, 45.214319],
                    [5.68056, 45.213597],
                    [5.682558, 45.21246],
                    [5.683693, 45.212032],
                    [5.685226, 45.211695],
                    [5.688486, 45.210987],
                    [5.695176, 45.209975],
                    [5.69887, 45.20861],
                    [5.702106, 45.207509],
                    [5.703666, 45.206955],
                    [5.705088, 45.206436],
                    [5.70624, 45.205961],
                    [5.70689, 45.205744],
                    [5.707702, 45.205551],
                    [5.709353, 45.205181],
                    [5.709839, 45.205055],
                    [5.710186, 45.204929],
                    [5.710829, 45.204623],
                    [5.711085, 45.204449],
                    [5.713141, 45.202975],
                    [5.713655, 45.202574],
                    [5.713938, 45.202307],
                    [5.714478, 45.201734],
                    [5.714772, 45.20139],
                    [5.715034, 45.200977],
                    [5.715193, 45.200679],
                    [5.715403, 45.200067],
                    [5.715465, 45.199829],
                    [5.715458, 45.199612],
                    [5.717848, 45.199787],
                    [5.717819, 45.199913],
                    [5.720918, 45.199238],
                    [5.720951, 45.199052],
                    [5.721985, 45.198795],
                    [5.721937, 45.198655],
                    [5.722024, 45.19854],
                    [5.722582, 45.19855],
                    [5.72302, 45.198392],
                    [5.723067, 45.198303],
                    [5.723694, 45.198557],
                    [5.723767, 45.19839],
                    [5.723885, 45.198399],
                    [5.723805, 45.19869],
                    [5.724511, 45.198753],
                    [5.724486, 45.198933],
                    [5.724928, 45.198909],
                    [5.725515, 45.199656],
                    [5.725313, 45.200307],
                    [5.725128, 45.200506],
                    [5.725244, 45.200651],
                    [5.725183, 45.201135],
                    [5.724433, 45.202351],
                    [5.724845, 45.20418],
                    [5.725715, 45.205014],
                    [5.731737, 45.202213],
                    [5.733524, 45.201845],
                    [5.733816, 45.201947],
                    [5.734103, 45.201791],
                    [5.734894, 45.201271],
                    [5.735523, 45.201695],
                    [5.735877, 45.2019],
                    [5.736402, 45.202116],
                    [5.73669, 45.202184],
                    [5.73695, 45.20221],
                    [5.737685, 45.202206],
                    [5.738058, 45.202169],
                    [5.739103, 45.201941],
                    [5.739351, 45.201853],
                    [5.739697, 45.201659],
                    [5.741082, 45.200846],
                    [5.741421, 45.200568],
                    [5.741915, 45.200105],
                    [5.742276, 45.199599],
                    [5.742582, 45.19909],
                    [5.742916, 45.198354],
                    [5.743132, 45.197793],
                    [5.743245, 45.197201],
                    [5.743262, 45.196799],
                    [5.743162, 45.196083],
                    [5.743082, 45.195768],
                    [5.742904, 45.195316],
                    [5.742506, 45.19445],
                    [5.742169, 45.193779],
                    [5.741982, 45.193318],
                    [5.741924, 45.193097],
                    [5.741794, 45.192466],
                    [5.741789, 45.192232],
                    [5.741931, 45.191565],
                    [5.742048, 45.191186],
                    [5.742283, 45.190688],
                    [5.74271, 45.190202],
                    [5.74308, 45.189903],
                    [5.743552, 45.189617],
                    [5.743874, 45.189467],
                    [5.744575, 45.189228],
                    [5.745417, 45.188989],
                    [5.746329, 45.188836],
                    [5.74678, 45.188806],
                    [5.747654, 45.188786],
                    [5.748057, 45.1888],
                    [5.748391, 45.188845],
                    [5.748934, 45.18896],
                    [5.749281, 45.189088],
                    [5.748386, 45.188336],
                    [5.748028, 45.188017],
                    [5.747798, 45.18788],
                    [5.747089, 45.187139],
                    [5.746501, 45.186602],
                    [5.7464, 45.186455],
                    [5.74641, 45.186294],
                    [5.746544, 45.186104],
                    [5.746593, 45.185934],
                    [5.746754, 45.185891],
                    [5.74681, 45.185816],
                    [5.747193, 45.18549],
                    [5.747383, 45.185274],
                    [5.747438, 45.185116],
                    [5.747349, 45.184658],
                    [5.7474, 45.184304],
                    [5.74786, 45.182425],
                    [5.747987, 45.182183],
                    [5.748238, 45.182015],
                    [5.748997, 45.181586],
                    [5.75026, 45.180847],
                    [5.750357, 45.180779],
                    [5.750453, 45.180616],
                    [5.750672, 45.179933],
                    [5.750858, 45.179279],
                    [5.751098, 45.178983],
                    [5.751455, 45.178402],
                    [5.751684, 45.177835],
                    [5.751831, 45.17739],
                    [5.752033, 45.177021],
                    [5.752325, 45.17657],
                    [5.752598, 45.17649],
                    [5.752626, 45.176211],
                    [5.752898, 45.175805],
                    [5.753078, 45.175627],
                    [5.752851, 45.175395],
                    [5.752709, 45.175126],
                    [5.752375, 45.173991],
                    [5.751925, 45.17272],
                    [5.751495, 45.171637],
                    [5.751375, 45.171531],
                    [5.751267, 45.17133],
                    [5.751187, 45.171107],
                    [5.751027, 45.170831],
                    [5.750592, 45.170175],
                    [5.750458, 45.169906],
                    [5.750282, 45.169659],
                    [5.750037, 45.16951],
                    [5.749985, 45.169358],
                    [5.749812, 45.16923],
                    [5.749725, 45.168897],
                    [5.749185, 45.169068],
                    [5.747153, 45.169821],
                    [5.745983, 45.171052],
                    [5.745751, 45.171285],
                    [5.745621, 45.171498],
                    [5.745422, 45.171593],
                    [5.745118, 45.170196],
                    [5.744785, 45.169309],
                    [5.744153, 45.168338],
                    [5.743949, 45.16812],
                    [5.743022, 45.166374],
                    [5.74124, 45.166798],
                    [5.740799, 45.165659],
                    [5.741226, 45.165531],
                    [5.741387, 45.16523],
                    [5.740982, 45.164723],
                    [5.740933, 45.164473],
                    [5.741424, 45.164094],
                    [5.74086, 45.1637],
                    [5.740294, 45.163239],
                    [5.740148, 45.162879],
                    [5.739846, 45.161246],
                    [5.739918, 45.160662],
                    [5.739793, 45.159849],
                    [5.738975, 45.159606],
                    [5.73755, 45.159309],
                    [5.737257, 45.158023],
                    [5.737025, 45.158016],
                    [5.73716, 45.155879],
                    [5.737696, 45.155859],
                    [5.737768, 45.154206],
                    [5.734862, 45.154148],
                    [5.734818, 45.155119],
                    [5.733811, 45.155097],
                    [5.733759, 45.154886],
                    [5.733117, 45.154792],
                    [5.731757, 45.154792],
                    [5.731654, 45.157285],
                    [5.730511, 45.157407],
                    [5.730331, 45.158884],
                    [5.729056, 45.158853],
                    [5.728956, 45.159166],
                    [5.727963, 45.159182],
                    [5.726137, 45.159224],
                    [5.723451, 45.159531],
                    [5.722053, 45.15977],
                    [5.721194, 45.160022],
                    [5.720192, 45.160076],
                    [5.720173, 45.159762],
                    [5.720028, 45.159171],
                    [5.719367, 45.159079],
                    [5.715083, 45.158927],
                    [5.714343, 45.158865],
                    [5.713224, 45.15885],
                    [5.710929, 45.158761],
                    [5.710239, 45.158525],
                    [5.710031, 45.15841],
                    [5.709334, 45.158574],
                    [5.708894, 45.158654],
                    [5.708315, 45.15871],
                    [5.707729, 45.158731],
                    [5.706145, 45.158737],
                    [5.704329, 45.158708],
                    [5.703524, 45.158659],
                    [5.703124, 45.158711],
                    [5.702816, 45.158823],
                    [5.702198, 45.159145],
                    [5.701765, 45.159383],
                    [5.701312, 45.159582],
                    [5.70102, 45.159616],
                    [5.70021, 45.160251],
                    [5.699699, 45.160431],
                    [5.699797, 45.160733],
                    [5.699949, 45.161116],
                    [5.70011, 45.161666],
                    [5.700181, 45.161826],
                    [5.700353, 45.162046],
                    [5.700574, 45.162236],
                    [5.700694, 45.162436],
                    [5.700791, 45.162701],
                    [5.700926, 45.163471],
                    [5.700947, 45.163983],
                    [5.700855, 45.164746],
                    [5.700878, 45.166757],
                    [5.700761, 45.167457],
                    [5.700504, 45.168301],
                    [5.700491, 45.168778],
                    [5.700666, 45.170801],
                    [5.700741, 45.171081],
                    [5.701149, 45.17156],
                    [5.70123, 45.171763],
                    [5.700787, 45.172307],
                    [5.700742, 45.172625],
                    [5.700973, 45.173733],
                    [5.701017, 45.1748],
                    [5.701134, 45.17574],
                    [5.701275, 45.176747],
                    [5.701077, 45.177099],
                    [5.700873, 45.177351],
                    [5.700841, 45.177641],
                    [5.700869, 45.178589],
                    [5.70099, 45.179984],
                    [5.701156, 45.179984],
                    [5.701195, 45.180129],
                    [5.70125, 45.181322],
                    [5.701248, 45.182285],
                    [5.701336, 45.182973],
                    [5.701393, 45.185075],
                    [5.701543, 45.187863],
                    [5.701626, 45.189223],
                    [5.701642, 45.190762],
                    [5.701775, 45.193327],
                    [5.701731, 45.193696],
                    [5.701523, 45.194525],
                    [5.701387, 45.195158],
                    [5.701288, 45.195382],
                    [5.700549, 45.19664],
                    [5.700229, 45.197087],
                    [5.699976, 45.197338],
                    [5.699629, 45.197627],
                    [5.699296, 45.197881],
                    [5.698691, 45.198272],
                    [5.698284, 45.198484],
                    [5.69457, 45.200951],
                    [5.693086, 45.202018],
                    [5.68781, 45.20591],
                    [5.678003, 45.213141],
                    [5.678683, 45.213686],
                ]
            ]
        ],
    }
    geom = GEOSGeometry(json.dumps(geometry), srid=4326)
    return City.objects.create(name="Grenoble", shape=geom, code_insee="38185")


def create_from_geojson(geojson_data):
    for feature in geojson_data["features"]:
        geom = GEOSGeometry(json.dumps(feature["geometry"]), srid=4326)

        b = Building.objects.create(
            rnb_id=feature["properties"]["rnb_id"],
            shape=geom,
            point=geom.point_on_surface,
            status="constructed",
        )


def coords_to_mp_geom(coords_list):
    coords = {
        "coordinates": [[coords_list]],
        "type": "MultiPolygon",
    }
    geom = GEOSGeometry(json.dumps(coords), srid=4326)
    return geom


def coords_to_point_geom(lng: float, lat: float):
    coords = {
        "coordinates": [lng, lat],
        "type": "Point",
    }
    geom = GEOSGeometry(json.dumps(coords), srid=4326)
    return geom


def create_bdg(rnb_id, coords_list):
    geom = coords_to_mp_geom(coords_list)

    return Building.objects.create(
        rnb_id=rnb_id,
        shape=geom,
        point=geom.point_on_surface,
    )


def create_default_bdg(rnb_id="DEFAULT"):
    # The building is located in Grenoble
    coords = [
        [5.717918517856731, 45.178820091145724],
        [5.718008279271032, 45.17865980057857],
        [5.7184092135875915, 45.17866401875747],
        [5.7184451181529425, 45.17884961830637],
        [5.717924501950705, 45.17893819969589],
        [5.717918517856731, 45.178820091145724],
    ]
    return create_bdg(rnb_id, coords)


def create_default_ads(city: City, file_number="PC1234"):
    return ADS.objects.create(
        file_number=file_number, decided_at="2023-01-01", city=city
    )


def mock_ban_geocoder_result(id: str, lng: float, lat: float, score=0.99) -> Response:
    r = Response()
    r.status_code = 200
    r._content = json.dumps(
        {
            "features": [
                {
                    "geometry": {"coordinates": [lng, lat], "type": "Point"},
                    "properties": {
                        "id": id,
                        "score": score,
                        "type": "housenumber",
                        "x": lng,
                        "y": lat,
                    },
                    "type": "Feature",
                }
            ],
            "type": "FeatureCollection",
        }
    ).encode()

    return r


def mock_photon_geocoder_empty_result() -> Response:
    r = Response()
    r.status_code = 200
    r._content = json.dumps({"features": [], "type": "FeatureCollection"}).encode()

    return r


# loads the village fixture in the database
# useful from a jupyter notebook
def create_village():
    from django.core.management import call_command

    call_command("loaddata", "village.json", verbosity=0, app_label="batid")
    call_command("loaddata", "village_plots.json", verbosity=0, app_label="batid")


# création d'un décorateur qui vide la table building (et les tables associées en cascade)
class insert_village(ContextDecorator):
    cursor = connection.cursor()

    def __enter__(self):
        self.cursor.execute("BEGIN TRANSACTION")
        self.cursor.execute("TRUNCATE TABLE batid_building CASCADE")
        self.cursor.execute("TRUNCATE TABLE batid_city CASCADE")
        create_village()
        return self

    def __exit__(self, *exc):
        self.cursor.execute("ROLLBACK TRANSACTION")
        return False


# le décorateur précédent est appelé par le décorateur transaction.atomic() qui permet de ne pas faire de commit
# dans la base après chaque execution SQL, mais de tout wrapper dans une transaction que l'on peut rollback
# une fois terminée
def in_village(func):
    from django.db import transaction

    return transaction.atomic(insert_village()(func))


def fixture_path(filename):
    file_dir = os.path.dirname(os.path.realpath("__file__"))
    return os.path.join(file_dir, "batid/fixtures", filename)
