from django.test import TestCase
from batid.utils.geo import fix_nested_shells
from django.contrib.gis.geos import GEOSGeometry


class TestGeo(TestCase):
    def test_nested_shells(self):
        # a polygon with nested shells
        geo = GEOSGeometry(
            "MULTIPOLYGON (((-0.2603853911940558 49.28965287729145, -0.2603492357597302 49.289646656653346, -0.2601919722379587 49.28961761705052, -0.2601573249932863 49.28967883386184, -0.2601100142797246 49.289670215456006, -0.2600829132996282 49.289742024849495, -0.2600835372682349 49.28975190479929, -0.2597996280503088 49.28967770237899, -0.2598189113333403 49.289569216168644, -0.2598606633102674 49.28948981328902, -0.2599149529332891 49.28950004264068, -0.259950281006515 49.28944960401875, -0.2599786866280709 49.28939845271888, -0.2600636956020137 49.289415949344345, -0.2601529745653078 49.28926148584007, -0.2602535416034688 49.28928575960524, -0.2602808223260912 49.28930391632477, -0.2604181455197162 49.289387477297794, -0.2605629945867315 49.2893070874089, -0.2606026787915336 49.28934740161674, -0.2604369374270364 49.28944545064519, -0.2604016446979928 49.28943110931731, -0.2603307959006165 49.289572479006665, -0.2603853911940558 49.28965287729145)), ((-0.2600423473011662 49.2895352879472, -0.2601168819564045 49.289561164955025, -0.2601306015839213 49.28958238727533, -0.2601185719608941 49.28960970363805, -0.260099858555504 49.28961830668996, -0.2600667897990501 49.289617400823474, -0.2599983715870132 49.28960125532731, -0.2600423473011662 49.2895352879472)))"
        )

        self.assertEqual(geo.valid, False)
        self.assertIn("Nested shells", geo.valid_reason)

        fixed_geo = fix_nested_shells(geo)

        self.assertEqual(fixed_geo.valid, True)
        self.assertEqual(geo.envelope, fixed_geo.envelope)
